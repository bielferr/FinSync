<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - FinSync</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/js/data-manager.js"></script>
    <script src="/js/auth.js"></script>
    <script type="module">
    import { loadGlobalData, getState } from "./static/js/state.js";

    (async () => {
        await loadGlobalData();
        const state = getState();

        console.log("Dados no dashboard:", state);
    })();
    </script>

    <style>
        .badge-success {
            background: #D1FAE5;
            color: #065F46;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-error {
            background: #FEE2E2;
            color: #991B1B;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: var(--secondary);
            font-size: 0.875rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .stat-card {
            text-align: center;
            padding: 16px;
            background: var(--light);
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="/" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 12px;">
                    <div class="logo">
                        <i class="fas fa-comments"></i>
                    </div>
                    <span class="brand-name">Blync</span>
                </a>
            </div>
            
            <div class="nav-menu">
                <a href="/dashboard.html" class="nav-link">Dashboard</a>
                <a href="/hist.html" class="nav-link">Histórico</a>
                <a href="/cartoes.html" class="nav-link">Cartões</a>
                <a href="/perfil.html" class="nav-link active">Perfil</a>
                <a href="/suporte.html" class="nav-link active">Blinkie</a>

            </div>
            
            <div class="nav-actions">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <a href="/configuracoes.html" class="btn btn-outline">
                    <i class="fas fa-cog"></i>
                    Configurações
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Meu Perfil</h1>
                <p class="page-subtitle">Gerencie suas informações pessoais e visualize seu saldo</p>
            </div>

            <div class="grid grid-2">
                <!-- Informações do Usuário -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Informações Pessoais</h2>
                    </div>
                    
                    <div class="user-info">
                        <div class="user-avatar" style="text-align: center; margin-bottom: 24px;">
                            <div style="width: 80px; height: 80px; background: var(--gradient); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: 600;">
                                <span id="userInitials">US</span>
                            </div>
                        </div>
                        
                        <div class="info-grid" style="display: grid; gap: 16px;">
                            <div class="info-item">
                                <label style="font-size: 0.875rem; color: var(--secondary);">Nome Completo</label>
                                <p style="font-weight: 500; margin-top: 4px;" id="userName">Carregando...</p>
                            </div>
                            
                            <div class="info-item">
                                <label style="font-size: 0.875rem; color: var(--secondary);">E-mail</label>
                                <p style="font-weight: 500; margin-top: 4px;" id="userEmail">Carregando...</p>
                            </div>
                            
                            <div class="info-item">
                                <label style="font-size: 0.875rem; color: var(--secondary);">Data de Entrada</label>
                                <p style="font-weight: 500; margin-top: 4px;" id="userJoinDate">Carregando...</p>
                            </div>
                            
                            <div class="info-item">
                                <label style="font-size: 0.875rem; color: var(--secondary);">Tipo de Conta</label>
                                <p style="font-weight: 500; margin-top: 4px;">
                                    <span class="badge badge-success" id="userRole">Usuário</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Saldo e Estatísticas -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Saldo Atual</h2>
                    </div>
                    
                    <div class="balance-section">
                        <div style="text-align: center; margin-bottom: 32px;">
                            <div class="stat-value" id="currentBalance">R$ 0,00</div>
                            <p class="stat-label">Saldo Disponível</p>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" style="color: var(--success);" id="monthIncome">R$ 0,00</div>
                                <div class="stat-label">Entradas este mês</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-value" style="color: var(--error);" id="monthExpense">R$ 0,00</div>
                                <div class="stat-label">Saídas este mês</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Últimas Transações -->
            <div class="card" style="margin-top: 32px;">
                <div class="card-header">
                    <h2 class="card-title">Últimas Transações</h2>
                    <a href="/hist.html" class="btn btn-outline btn-small">
                        Ver Todas
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Data</th>
                                <th>Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <!-- Transações serão carregadas via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        
document.addEventListener('DOMContentLoaded', function() {
    if (!window.authManager?.requireAuth()) return;
    
    loadProfileData();
});

function loadProfileData() {
    // Carregar dados do usuário
    const userData = BlyncDataManager.getUserData();
    if (userData) {
        document.getElementById('userName').textContent = userData.name;
        document.getElementById('userEmail').textContent = userData.email;
        document.getElementById('userInitials').textContent = getUserInitials(userData.name);
        document.getElementById('userJoinDate').textContent = BlyncDataManager.formatDate(userData.createdAt);
        
        const roleElement = document.getElementById('userRole');
        roleElement.textContent = userData.role === 'admin' ? 'Administrador' : 'Usuário';
    }
    
    // Carregar dados financeiros
    loadFinancialData();
    loadRecentTransactions();
}

function loadFinancialData() {
    const stats = BlyncDataManager.calculateStats();
    document.getElementById('currentBalance').textContent = BlyncDataManager.formatCurrency(stats.totalBalance);
    document.getElementById('monthIncome').textContent = BlyncDataManager.formatCurrency(stats.monthIncome);
    document.getElementById('monthExpense').textContent = BlyncDataManager.formatCurrency(stats.monthExpense);
}

function loadRecentTransactions() {
    const transactions = BlyncDataManager.getTransactions()
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
    
    const tbody = document.getElementById('recentTransactions');
    
    if (transactions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">Nenhuma transação</td></tr>`;
        return;
    }
    
    tbody.innerHTML = transactions.map(transaction => `
        <tr>
            <td>${transaction.description}</td>
            <td>${BlyncDataManager.getCategoryName(transaction.category)}</td>
            <td>${BlyncDataManager.formatDate(transaction.date)}</td>
            <td style="color: ${transaction.type === 'income' ? 'var(--success)' : 'var(--error)'}">
                ${transaction.type === 'income' ? '+' : '-'} ${BlyncDataManager.formatCurrency(transaction.amount)}
            </td>
            <td>
                <span class="${transaction.type === 'income' ? 'badge-success' : 'badge-error'}">
                    ${transaction.type === 'income' ? 'Entrada' : 'Saída'}
                </span>
            </td>
        </tr>
    `).join('');
}

        // Verificar autenticação usando o AuthManager
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.authManager || !window.authManager.requireAuth()) {
                return;
            }
            
            // Carregar dados do usuário
            loadUserData();
            setupThemeToggle();
        });

            document.addEventListener('DOMContentLoaded', function() {
        if (!window.authManager || !window.authManager.requireAuth()) {
            return;
        }
        // Resto do código da página...
    });

        // Theme Toggle
        function setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const currentTheme = document.body.dataset.theme;
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    document.body.dataset.theme = newTheme;
                    
                    // Atualizar ícone
                    const icon = themeToggle.querySelector('i');
                    icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                    
                    // Salvar preferência
                    localStorage.setItem('theme', newTheme);
                });

                // Carregar tema salvo
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.body.dataset.theme = savedTheme;
                const icon = themeToggle.querySelector('i');
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // Carregar dados do usuário da sessão
        function loadUserData() {
            try {
                // Usar o AuthManager para obter dados do usuário
                const authData = window.authManager.getAuthData();
                const user = authData.user;

                if (!user) {
                    console.error('Usuário não encontrado na sessão');
                    window.authManager.showAlert('Erro ao carregar dados do usuário', 'error');
                    return;
                }

                console.log('Dados do usuário:', user);

                // Atualizar informações básicas
                document.getElementById('userName').textContent = user.name || 'Usuário';
                document.getElementById('userEmail').textContent = user.email || 'E-mail não disponível';
                
                // Tipo de conta
                const roleElement = document.getElementById('userRole');
                if (user.role === 'admin') {
                    roleElement.textContent = 'Administrador';
                    roleElement.className = 'badge badge-success';
                } else {
                    roleElement.textContent = 'Usuário';
                    roleElement.className = 'badge badge-success';
                }
                
                // Iniciais do avatar
                document.getElementById('userInitials').textContent = getUserInitials(user.name);
                
                // Data de entrada - usar createdAt se disponível, senão usar data atual
                const joinDate = user.createdAt ? new Date(user.createdAt) : new Date();
                document.getElementById('userJoinDate').textContent = joinDate.toLocaleDateString('pt-BR');
                
                // Carregar saldo e transações
                loadBalance();
                loadRecentTransactions();
                
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                window.authManager.showAlert('Erro ao carregar informações do perfil', 'error');
                
                // Fallback: tentar carregar diretamente do localStorage
                loadUserDataFallback();
            }
        }

        // Fallback caso o AuthManager não esteja disponível
        function loadUserDataFallback() {
            try {
                const userStr = localStorage.getItem('blync_user');
                const user = userStr ? JSON.parse(userStr) : null;
                
                if (user) {
                    document.getElementById('userName').textContent = user.name || 'Usuário';
                    document.getElementById('userEmail').textContent = user.email || 'E-mail não disponível';
                    document.getElementById('userInitials').textContent = getUserInitials(user.name);
                    
                    const roleElement = document.getElementById('userRole');
                    if (user.role === 'admin') {
                        roleElement.textContent = 'Administrador';
                    } else {
                        roleElement.textContent = 'Usuário';
                    }
                    
                    document.getElementById('userJoinDate').textContent = new Date().toLocaleDateString('pt-BR');
                }
            } catch (error) {
                console.error('Erro no fallback:', error);
            }
        }

        function getUserInitials(name) {
            if (!name) return 'US';
            return name.split(' ')
                      .map(n => n[0])
                      .join('')
                      .toUpperCase()
                      .substring(0, 2);
        }

        async function loadBalance() {
            try {
                // Tentar carregar do sistema de dados unificado (se existir)
                if (window.BlyncDataManager) {
                    const stats = window.BlyncDataManager.calculateStats();
                    document.getElementById('currentBalance').textContent = formatCurrency(stats.totalBalance);
                    document.getElementById('monthIncome').textContent = formatCurrency(stats.monthIncome);
                    document.getElementById('monthExpense').textContent = formatCurrency(stats.monthExpense);
                } else {
                    // Dados simulados como fallback
                    setTimeout(() => {
                        document.getElementById('currentBalance').textContent = 'R$ 2.543,67';
                        document.getElementById('monthIncome').textContent = 'R$ 3.200,00';
                        document.getElementById('monthExpense').textContent = 'R$ 656,33';
                    }, 1000);
                }
            } catch (error) {
                console.error('Erro ao carregar saldo:', error);
                // Dados simulados em caso de erro
                document.getElementById('currentBalance').textContent = 'R$ 2.543,67';
                document.getElementById('monthIncome').textContent = 'R$ 3.200,00';
                document.getElementById('monthExpense').textContent = 'R$ 656,33';
            }
        }

        async function loadRecentTransactions() {
            try {
                // Tentar carregar do sistema de dados unificado (se existir)
                if (window.BlyncDataManager) {
                    const transactions = window.BlyncDataManager.getTransactions()
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 5);
                    
                    renderTransactions(transactions);
                } else {
                    // Dados simulados como fallback
                    const transactions = [
                        { 
                            description: 'Salário', 
                            category: 'Receita', 
                            date: '15/03/2024', 
                            amount: 3000.00, 
                            type: 'income' 
                        },
                        { 
                            description: 'Supermercado', 
                            category: 'Alimentação', 
                            date: '18/03/2024', 
                            amount: 256.33, 
                            type: 'expense' 
                        },
                        { 
                            description: 'Internet', 
                            category: 'Utilidades', 
                            date: '20/03/2024', 
                            amount: 120.00, 
                            type: 'expense' 
                        },
                        { 
                            description: 'Freelance', 
                            category: 'Receita', 
                            date: '22/03/2024', 
                            amount: 200.00, 
                            type: 'income' 
                        },
                        { 
                            description: 'Restaurante', 
                            category: 'Alimentação', 
                            date: '25/03/2024', 
                            amount: 80.00, 
                            type: 'expense' 
                        }
                    ];
                    
                    renderTransactions(transactions);
                }
            } catch (error) {
                console.error('Erro ao carregar transações:', error);
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('recentTransactions');
            
            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--secondary);">
                            Nenhuma transação recente
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = transactions.map(transaction => `
                <tr>
                    <td>${transaction.description}</td>
                    <td>${transaction.category}</td>
                    <td>${formatDate(transaction.date)}</td>
                    <td style="color: ${transaction.type === 'income' ? 'var(--success)' : 'var(--error)'}; font-weight: 500;">
                        ${transaction.type === 'income' ? '+' : '-'} ${formatCurrency(transaction.amount)}
                    </td>
                    <td>
                        <span class="badge ${transaction.type === 'income' ? 'badge-success' : 'badge-error'}">
                            ${transaction.type === 'income' ? 'Entrada' : 'Saída'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Funções utilitárias
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(dateString) {
            if (!dateString) return 'Data inválida';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            } catch (error) {
                return dateString; // Retorna a string original se não puder converter
            }
        }

        // Verificação adicional de autenticação
        function checkAuth() {
            const token = localStorage.getItem('blync_token');
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
    </script>
</body>
</html>